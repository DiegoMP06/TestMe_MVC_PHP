import UI from"../../../layout/UI.js";import TiposCampos from"../../db/TiposCampos.js";import{crearVisita,test}from"./funcionesTestEdu.js";export default class EduTest{constructor(){this.camposExtra=[],this.campos=[],this.puntuacion=0,this.total=0}modificarCampo(t){this.campos=this.campos.map(e=>parseInt(t.id)===parseInt(e.id)?t:e)}modificarCampoExtra(t){this.camposExtra=this.camposExtra.map(e=>parseInt(t.id)===parseInt(e.id)?t:e)}mostrarCamposExtra(t){console.log(test.instrucciones);const{campos:e}=test,a=document.createElement("DIV");a.classList.add("contenedor-campos"),e.forEach(t=>{const{id:e,type:o,nombre:r}=t,i=TiposCampos.filter(t=>t.type===o)[0],n=document.createElement("DIV");n.classList.add("campo");const s={id:Math.round(Math.random()*Date.now()),name:e,type:o,pregunta:r,valor:""};if(1===i.id||2===i.id){const{atributos:{placeholder:a},atributos:c}=t,p=document.createElement("LABEL");p.textContent=r,p.setAttribute("for",e);const m=document.createElement("INPUT");if(m.placeholder=a,m.name=e,m.id=e,m.type=o,m.oninput=t=>{this.validarCampoExtra(t.target.parentElement,t.target.value.trim(),e)},2===i.id){const{entero:t,maximo:e,minimo:a}=c;s.entero=t,m.step=t?1:"any",(0==e||e)&&(m.max=e,s.maximo=e),(0==e||a)&&(m.min=a,s.minimo=a)}n.appendChild(p),n.appendChild(m)}if(3===i.id||4===i.id){const t=document.createElement("LABEL");t.textContent=r,t.setAttribute("for",e);const a=document.createElement("INPUT");a.name=e,a.id=e,a.type=o,a.oninput=t=>{this.validarCampoExtra(t.target.parentElement,t.target.value.trim(),e)},n.appendChild(t),n.appendChild(a)}if(5===i.id||6===i.id){n.className="campo-radio";const{opciones:a}=t;s.opciones=[];const c=document.createElement("P");c.textContent=r,c.dataset.for=e;const p=document.createElement("DIV");p.classList.add("campo-multiple","opciones-test"),p.dataset.id=e,a.forEach(t=>{const{id:a,opcion:r,valor:n}=t,c=document.createElement("DIV");c.classList.add("radio");const m=document.createElement("LABEL"),d=document.createElement("INPUT");m.textContent=r,m.setAttribute("for",a),d.name=e,d.id=a,d.type=o,d.oninput=t=>{this.validarCampoExtra(t.target.parentElement.parentElement.parentElement,n,e,a,t.target.checked)},c.appendChild(d),c.appendChild(m),p.appendChild(c);const l={id:a,opcion:r,valor:n};5===i.id&&(l.checked=!1),s.opciones=[...s.opciones,l]}),n.appendChild(c),n.appendChild(p),5===i.id&&(s.valor=[])}a.appendChild(n),this.camposExtra=[...this.camposExtra,s]}),t.appendChild(a)}validarCampoExtra(t,e,a,o,r){const{camposExtra:i}=this,[n]=i.filter(t=>parseInt(t.name)===parseInt(a));if(""===e)return void UI.mostrarAlerta("El Campo es Obligatorio",t,!1);if("number"===n.type){const{entero:a,minimo:o,maximo:r}=n;if(a&&!Number.isInteger(Number(e)))return void UI.mostrarAlerta("El Valor Es Invalido",t,!1);if(o&&r&&(Number(e)<o||Number(e)>r))return void UI.mostrarAlerta("Numero Invalido",t,!1)}if("date"===n.type&&isNaN(Date.parse(e)))return void UI.mostrarAlerta("Fecha Invalida",t,!1);const s=t.querySelector(".alerta");s&&s.remove(),this.obtenerDatosCampoExtra(e,{...n},o,r)}obtenerDatosCampoExtra(t,e,a,o){const{type:r}=e;if("checkbox"!==r)return e.valor=t,void this.modificarCampoExtra(e);const[i]=e.opciones.filter(t=>parseInt(t.id)===parseInt(a));i.checked=o,e.opciones=e.opciones.map(t=>parseInt(t.id)===a?i:t);const{opciones:n}=e,s=n.filter(t=>t.checked);e.valor=s.map(t=>t.valor),this.modificarCampoExtra(e)}sincronizarCampos(t,e,a){const[{...o}]=this.campos.filter(e=>parseInt(t)===parseInt(e.name)),{multiple:r}=o,[i]=o.opciones.filter(t=>parseInt(e)===t.id);if(!r)return o.valor=i,void this.modificarCampo(o);i.checked=a,o.opciones=o.opciones.map(t=>parseInt(t.id)===parseInt(e)?i:t);const n=o.opciones.filter(t=>t.checked);o.valor=n,this.modificarCampo(o)}validarFormulario(t){const e=this.camposExtra.filter(t=>""===t.valor||0===t.valor.length),a=this.campos.filter(t=>!t.multiple&&!t.valor.id||t.multiple&&0===t.valor.length);if(a.length>0||e.length>0)return UI.mostrarAlerta("Todos Los Campos Son Obligatorios",t),void this.mostrarAlertasCampos([...e,...a],t);const o=this.campos.filter(t=>!t.multiple),r=this.campos.filter(t=>t.multiple),i=o.reduce((t,e)=>t+parseInt(e.valor.valor),0),n=r.reduce((t,{valor:e})=>t+e.reduce((t,{valor:e})=>t+parseInt(e),0),0);this.puntuacion=i+n,this.total=test.calcularMinimoYMaximo().maximo,crearVisita()}mostrarAlertasCampos(t,e){t.forEach(t=>{const{opciones:a,name:o}=t;if(a){const t=e.querySelector(`p[data-for='${o}']`).parentElement;return void UI.mostrarAlerta("El Campo es Obligatorio",t)}const r=e.querySelector(`label[for="${o}"]`).parentElement;UI.mostrarAlerta("El Campo es Obligatorio",r)})}mostrarInformacionTest(t){const e=t.parentElement;t.remove();const{instrucciones:a}=test,{puntuacion:o}=this,[r]=a.filter(({minimo:t,maximo:e})=>parseInt(o)>=parseInt(t)&&parseInt(o)<=parseInt(e)),{titulo:i,instruccion:n}=r,s=document.createElement("DIV");s.classList.add("contenedor-test-edu");const c=document.createElement("DIV");c.classList.add("contenedor-instruccion");const p=document.createElement("H3");p.textContent=i;const m=UI.formatearDescripcion(n);c.appendChild(p),c.appendChild(m);const d=document.createElement("DIV");d.classList.add("acciones");const l=document.createElement("A");l.classList.add("boton-verde"),l.textContent="Ver Reporte",l.href="/pdf/visita?id="+this.id;const u=document.createElement("A");u.classList.add("boton-azul"),u.textContent="Descargar Reporte",u.href="/pdf/visita?id="+this.id,u.download=test.nombre.replaceAll(" ","_").replaceAll(".","_"),d.appendChild(l),d.appendChild(u),s.appendChild(c),s.appendChild(d),e.appendChild(s)}}