import{limpiarHtml}from"../../utilidades.js";import UI from"../../../layout/UI.js";import Test from"../../classes/tests/Test.js";import TestBasico from"../../classes/tests/TestBasico.js";import TestMedio from"../../classes/tests/TestMedio.js";import TestAvanzado from"../../classes/tests/TestAvanzado.js";import CrearTest from"./crearTest.js";import CrearTestBasico from"./crearTestBasico.js";import CrearTestMedio from"./crearTestMedio.js";import CrearTestAvanzado from"./crearTestAvanzado.js";export let test=new Test;let funcionesTest=new CrearTest;export const datos={pagina:1,minimo:0,maximo:0};const formulario=document.querySelector("#formulario-test"),asideVisible=document.querySelector("#aside-visible");let categorias=[],tiposTests=[];export async function obtenerDatos(){try{const e=await Promise.all([fetch("/api/categorias"),fetch("/api/tipostests")]),[t,o]=e,n=await t.json(),a=await o.json();"exito"===n.tipo&&"exito"===a.tipo&&(categorias=n.categorias,tiposTests=a.tiposTests,mostrarFormulario(),mostrarOpcionesAside())}catch(e){console.log(e)}}async function consultarCrear(){const{nombre:e,descripcion:t,campos:o,instrucciones:n,preguntas:a,opciones:r,numPreguntas:s,numOpciones:i,categoriaId:c,tipoTestId:d}=test,l=new FormData;l.append("nombre",e),l.append("descripcion",t),l.append("campos",JSON.stringify(o)),l.append("instrucciones",JSON.stringify(n)),l.append("preguntas",JSON.stringify(a)),l.append("opciones",JSON.stringify(r)),l.append("numPreguntas",s),l.append("numOpciones",i),l.append("categoriaId",c),l.append("tipoTestId",d);try{const e=await fetch("/api/test/crear",{method:"POST",body:l}),t=await e.json();if("exito"===t.tipo){const{url:e}=t;window.location="/test?url="+e}}catch(e){console.error(e)}}export function cambiarPagina(e){datos.pagina=e,mostrarFormulario()}function mostrarOpcionesAside(){const e=document.createElement("DIV");e.classList.add("opciones");const t=document.createElement("BUTTON");t.textContent="Mostrar Preguntas",t.classList.add("boton-gris-block"),t.onclick=()=>{funcionesTest.mostrarModalPreguntas()};const o=document.createElement("BUTTON");o.textContent="Mostrar Opciones",o.classList.add("boton-gris-block"),o.onclick=()=>{funcionesTest.mostrarModalOpciones()};const n=document.createElement("BUTTON");n.textContent="Mostrar Instrucciones",n.classList.add("boton-gris-block"),n.onclick=()=>{funcionesTest.mostrarModalInstrucciones()};const a=document.createElement("BUTTON");a.textContent="Administrar Campos Extra",a.classList.add("boton-azul-block"),a.onclick=()=>{funcionesTest.mostrarModalCamposExtras()},e.appendChild(t),e.appendChild(o),e.appendChild(n),e.appendChild(a),asideVisible.appendChild(e)}export function mostrarFormulario(){const{pagina:e}=datos;switch(limpiarHtml(formulario),e){case 1:formulario1();break;case 2:formulario2();break;case 3:formulario3();break;case 4:mostrarTest();break;default:console.error("Hubo UN error")}}function formulario1(){const{nombre:e,descripcion:t,categoriaId:o,tipoTestId:n}=test,a=document.createElement("DIV"),r=document.createElement("LABEL"),s=document.createElement("INPUT");a.classList.add("campo"),r.textContent="Nombre: ",r.setAttribute("for","nombre"),s.classList.add("input"),s.placeholder="Nombre del Test",s.name="nombre",s.id="nombre",s.value=e,a.appendChild(r),a.appendChild(s);const i=document.createElement("DIV"),c=document.createElement("LABEL"),d=document.createElement("TEXTAREA");i.classList.add("campo"),c.textContent="Descripcion: ",c.setAttribute("for","descripcion"),d.classList.add("input"),d.placeholder="Descipcion del Test",d.name="descripcion",d.id="descripcion",d.value=t,i.appendChild(c),i.appendChild(d);const l=document.createElement("DIV"),m=document.createElement("LABEL"),p=document.createElement("SELECT");l.classList.add("campo"),m.textContent="Categoria: ",m.setAttribute("for","categoriaId"),p.classList.add("input"),p.name="categoriaId",p.id="categoriaId";const u=document.createElement("OPTION");u.value="",u.textContent="-- Seleccione --",u.selected=!0,u.disabled=!0,p.appendChild(u),categorias.forEach(e=>{const{id:t,nombre:n}=e,a=document.createElement("OPTION");a.value=t,a.textContent=n,parseInt(e.id)===parseInt(o)&&(a.selected=!0),p.appendChild(a)}),l.appendChild(m),l.appendChild(p);const f=document.createElement("DIV"),T=document.createElement("LABEL"),C=document.createElement("SELECT");f.classList.add("campo"),T.textContent="Tipo de Test: ",T.setAttribute("for","tipoTestId"),C.classList.add("input"),C.name="tipoTestId",C.id="tipoTestId",C.oninput=crearTest;const b=document.createElement("OPTION");b.value="",b.textContent="-- Seleccione --",b.selected=!0,b.disabled=!0,C.appendChild(b),tiposTests.forEach(e=>{const{id:t,nombre:o}=e,a=document.createElement("OPTION");a.value=t,a.textContent=o,parseInt(e.id)===parseInt(n)&&(a.selected=!0),C.appendChild(a)}),f.appendChild(T),f.appendChild(C),formulario.appendChild(a),formulario.appendChild(i),formulario.appendChild(l),formulario.appendChild(f),controles()}function formulario2(){funcionesTest.formulario2(formulario),controles()}function formulario3(){datos.maximo=test.calcularMinimoYMaximo().maximo,0===test.instrucciones.length&&(datos.minimo=test.calcularMinimoYMaximo().minimo);const{minimo:e,maximo:t}=datos,o=document.createElement("DIV");if(o.classList.add("instrucciones-crear"),e<=t){const n=document.createElement("DIV");n.innerHTML=`\n            <p class="alerta error">${e} a ${t}</p>\n        `,o.appendChild(n)}else{const e=document.createElement("DIV");e.innerHTML='\n            <p class="alerta exito">Has Cumplido Con Todos los Puntos</p>\n        ',o.appendChild(e)}if(formulario.appendChild(o),e<=t){const o=document.createElement("DIV");o.classList.add("campo-instruccion","seccion");const n=document.createElement("DIV"),a=document.createElement("LABEL"),r=document.createElement("INPUT");n.classList.add("campo"),a.textContent="Minimo: ",a.setAttribute("for","minimo"),r.placeholder="Puntaje Minimo",r.type="number",r.value=e,r.disabled=!0,r.id="minimo",r.name="minimo",r.classList.add("input"),n.appendChild(a),n.appendChild(r);const s=document.createElement("DIV"),i=document.createElement("LABEL"),c=document.createElement("INPUT");s.classList.add("campo"),i.textContent="Maximo: ",i.setAttribute("for","maximo"),c.placeholder="Puntaje Maximo",c.type="number",c.id="maximo",c.name="maximo",c.min=e,c.max=t,c.classList.add("input"),s.appendChild(i),s.appendChild(c);const d=document.createElement("DIV"),l=document.createElement("LABEL"),m=document.createElement("INPUT");d.classList.add("campo"),l.textContent="Titulo: ",l.setAttribute("for","titulo"),m.placeholder="Titulo de Instruccion",m.type="text",m.id="titulo",m.name="titulo",m.classList.add("input"),d.appendChild(l),d.appendChild(m);const p=document.createElement("DIV"),u=document.createElement("LABEL"),f=document.createElement("TEXTAREA");p.classList.add("campo"),u.textContent="Contenido: ",u.setAttribute("for","instruccion"),f.placeholder="Contenido de Instruccion",f.id="instruccion",f.name="instruccion",f.classList.add("input"),p.appendChild(u),p.appendChild(f);const T=document.createElement("BUTTON");T.type="button",T.textContent="Agregar Instruccion",T.classList.add("boton-verde"),T.onclick=e=>{funcionesTest.validarInstruccion(e.target.parentElement,t)},o.appendChild(n),o.appendChild(s),o.appendChild(d),o.appendChild(p),o.appendChild(T),formulario.appendChild(o)}controles()}function mostrarTest(){const{nombre:e,descripcion:t,numPreguntas:o,numOpciones:n,categoriaId:a,tipoTestId:r}=test,s=document.createElement("DIV");s.classList.add("test-preview");const i=document.createElement("H2");i.textContent=e;const c=UI.formatearDescripcion(t),d=document.createElement("DIV");d.classList.add("informacion-test","informacion");const l=document.createElement("P");l.textContent=`Numero de Preguntas: ${o} `;const m=document.createElement("P");m.textContent=`Numero de Opciones: ${n} `;const[p]=categorias.filter(e=>parseInt(e.id)===parseInt(a)),[u]=tiposTests.filter(e=>parseInt(e.id)===parseInt(r)),f=document.createElement("P");f.textContent="Categoria: "+p.nombre;const T=document.createElement("P");T.textContent="Test "+u.nombre,d.appendChild(l),d.appendChild(m),d.appendChild(f),d.appendChild(T);const C=document.createElement("DIV");C.classList.add("acciones-test","acciones-preview"),C.innerHTML='\n        <button class="boton-gris" id="mostrar-preguntas" type="button">Mostrar las Preguntas</button>\n        <button class="boton-gris" id="mostrar-opciones" type="button">Mostrar las Opciones</button>\n        <button class="boton-gris" id="mostrar-instrucciones" type="button">Mostrar las instrucciones</button>\n    ',C.onclick=e=>{"mostrar-preguntas"===e.target.id&&funcionesTest.mostrarModalPreguntas(),"mostrar-opciones"===e.target.id&&funcionesTest.mostrarModalOpciones(),"mostrar-instrucciones"===e.target.id&&funcionesTest.mostrarModalInstrucciones()},s.appendChild(i),s.appendChild(c),s.appendChild(d),s.appendChild(C),formulario.appendChild(s),controles()}function controles(){const{pagina:e}=datos;if(e>1){const e=document.createElement("BUTTON");e.classList.add("boton-azul"),e.type="button",e.textContent="Anterior",e.onclick=()=>{datos.pagina--,mostrarFormulario()},formulario.appendChild(e)}if(e<4){const e=document.createElement("BUTTON");e.classList.add("boton-azul"),e.type="button",e.textContent="Siguiente",e.onclick=()=>{validarFormulario()},formulario.appendChild(e)}if(4===e){const e=document.createElement("BUTTON");e.classList.add("boton-verde"),e.type="button",e.textContent="Crear Test",e.onclick=e=>{consultarCrear()},formulario.appendChild(e)}}function validarFormulario1(){const e=formulario.querySelector(".campo #nombre").value.trim(),t=formulario.querySelector(".campo #descripcion").value.trim(),o=formulario.querySelector(".campo #categoriaId").value.trim(),n=formulario.querySelector(".campo #tipoTestId").value.trim();if(""===e||""===t||""===o||""===n)return void UI.mostrarAlerta("Todos los campos son Obligatorios",formulario);const a=categorias.filter(e=>parseInt(e.id)===parseInt(o)),r=tiposTests.filter(e=>parseInt(e.id)===parseInt(n));0!==a.length&&0!==r.length?(test.nombre=e,test.descripcion=t,test.categoriaId=o,test.tipoTestId=n,datos.pagina++,mostrarFormulario()):UI.mostrarAlerta("Datos Invalidos",formulario)}function validarFormulario2(){const{opciones:e,preguntas:t,tipoTestId:o}=test;switch(parseInt(o)){case 1:if(t.length<5)return void UI.mostrarAlerta("Al Menos debes Agregar 5 Preguntas",formulario);if(e.length<2)return void UI.mostrarAlerta("Al Menos debes Agregar 2 Opciones",formulario);break;case 2:case 3:if(t.length!==e.length)return void UI.mostrarAlerta("Hubo Un Error Con La Cantida De Campos",formulario);if(t.length<5)return void UI.mostrarAlerta("AL Menos Deben de Ser 5 Campos",formulario);break;default:console.error("Hubo Un Error")}test.numOpciones=test.calcularNumOpciones(),test.numPreguntas=t.length,datos.pagina++,mostrarFormulario()}function validarFormulario3(){const{instrucciones:e}=test,t=test.calcularMinimoYMaximo().maximo,{minimo:o}=datos;0!==e.length?o<=t?UI.mostrarAlerta("Debes de Cubrir Todos Los Puntos",formulario):(datos.pagina++,mostrarFormulario()):UI.mostrarAlerta("Las Instrucciones Son Obligatorias",formulario)}function validarFormulario(){const{pagina:e}=datos;switch(e){case 1:validarFormulario1();break;case 2:validarFormulario2();break;case 3:validarFormulario3();break;default:console.error("Hubo UN error")}}function crearTest(e){switch(parseInt(e.target.value)){case 1:test=new TestBasico,funcionesTest=new CrearTestBasico;break;case 2:test=new TestMedio,funcionesTest=new CrearTestMedio;break;case 3:test=new TestAvanzado,funcionesTest=new CrearTestAvanzado;break;default:console.error("Ocurrio un Error")}}